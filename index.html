<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Sons United Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.11.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.11.0/mapbox-gl.js"></script>
  <script src="https://unpkg.com/supercluster@7.1.4/dist/supercluster.min.js"></script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: #22252D;
      font-family: 'Segoe UI', Arial, sans-serif;
      color: #fff;
      overflow: hidden;
    }
    #map {
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      right: 370px;
      width: auto;
      height: 100vh;
      z-index: 1;
      transition: right 0.2s;
    }
    .floating-panel {
      position: absolute;
      top: 0;
      right: 0;
      height: 100vh;
      width: 370px;
      max-width: 100vw;
      background: rgba(34,37,45,0.96);
      border-radius: 0 0 0 18px;
      box-shadow: -8px 0 32px 0 rgba(0,0,0,0.25);
      padding: 32px 24px 24px 24px;
      z-index: 10;
      display: flex;
      flex-direction: column;
      gap: 18px;
      backdrop-filter: blur(8px);
      border-left: 1.5px solid rgba(255,255,255,0.08);
      transition: box-shadow 0.2s;
      overflow-y: auto;
    }
    .floating-panel:hover {
      box-shadow: -12px 0 40px 0 rgba(0,0,0,0.35);
    }
    .title {
      color: #fff;
      font-size: 2rem;
      font-weight: 700;
      margin: 0 0 10px 0;
      letter-spacing: 1px;
      text-align: center;
      text-shadow: 0 2px 8px rgba(0,0,0,0.18);
    }
    .toolbar {
      display: flex;
      gap: 10px;
      margin-bottom: 0;
    }
    .toolbar input {
      flex: 1;
      padding: 10px 14px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      background: #23262F;
      color: #fff;
      outline: none;
      box-shadow: 0 1px 4px 0 rgba(0,0,0,0.10);
      transition: background 0.2s;
    }
    .toolbar input:focus {
      background: #292C36;
    }
    .toolbar button {
      background: linear-gradient(90deg, #ED2F24 60%, #ff5e3a 100%);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 10px 18px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 2px 8px 0 rgba(237,47,36,0.10);
      transition: background 0.2s, box-shadow 0.2s;
    }
    .toolbar button:hover {
      background: linear-gradient(90deg, #ff5e3a 0%, #ED2F24 100%);
      box-shadow: 0 4px 16px 0 rgba(237,47,36,0.18);
    }
    #info-box {
      background: rgba(255,255,255,0.06);
      border-radius: 10px;
      padding: 14px 14px 10px 14px;
      margin-bottom: 0;
      color: #fff;
      box-shadow: 0 1px 4px 0 rgba(0,0,0,0.08);
      font-size: 1rem;
      min-height: 38px;
      max-height: 60px;
      transition: min-height 0.2s, max-height 0.2s;
      overflow: hidden;
    }
    #info-box.expanded {
      min-height: 80px;
      max-height: 400px;
      transition: min-height 0.2s, max-height 0.2s;
    }
    #basic-info h3 {
      margin: 0 0 4px 0;
      font-size: 1.2rem;
      font-weight: 600;
      color: #fff;
    }
    #basic-info p {
      margin: 0 0 2px 0;
      color: #e0e0e0;
      font-size: 0.98rem;
    }
    #toggle-details {
      display: none;
      margin: 8px 0 0 0;
      background: #ED2F24;
      color: #fff;
      border: none;
      padding: 7px 16px;
      border-radius: 6px;
      font-size: 0.98rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }
    #toggle-details.visible {
      display: inline-block;
    }
    #toggle-details:hover {
      background: #ff5e3a;
    }
    #extra-details {
      display: none;
      background: rgba(255,255,255,0.10);
      padding: 10px 12px;
      border-radius: 8px;
      margin-top: 8px;
      color: #fff;
      font-size: 0.97rem;
    }
    #contact-list-module {
      background: rgba(255,255,255,0.06);
      border-radius: 10px;
      padding: 12px 10px 10px 10px;
      margin-top: 0;
      box-shadow: 0 1px 4px 0 rgba(0,0,0,0.08);
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    #sort-container {
      margin-bottom: 8px;
      text-align: left;
      color: #fff;
      font-size: 1rem;
      font-weight: 500;
    }
    #sort-select {
      padding: 5px 12px;
      border-radius: 6px;
      border: 1px solid #444;
      background: #23262F;
      color: #fff;
      font-size: 1rem;
      margin-left: 8px;
      outline: none;
      transition: border 0.2s;
    }
    #sort-select:focus {
      border: 1.5px solid #ED2F24;
    }
    #contact-list {
      list-style: none;
      margin: 0;
      padding: 0;
      max-height: 100%;
      overflow-y: auto;
      font-size: 1rem;
      flex: 1 1 auto;
      min-height: 0;
    }
    #contact-list li {
      background: rgba(255,255,255,0.13);
      margin: 3px 0;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      color: #fff;
      transition: background 0.18s, color 0.18s;
      outline: none;
    }
    #contact-list li:hover, #contact-list li:focus {
      background: #ED2F24;
      color: #fff;
    }
    #contact-list li.in-view {
      background: rgba(237,47,36,0.08); /* More subtle highlight */
      color: #fff;
      font-weight: 500;
      border-left: 3px solid #ED2F24;
    }
    #contact-list li.active-contact {
      background: linear-gradient(90deg, #ED2F24 60%, #ff5e3a 100%);
      color: #fff;
      font-weight: 700;
      border-left: 4px solid #fff;
    }
    .list-header {
      background: none;
      margin-top: 10px;
      padding: 0 0 2px 0;
      font-weight: bold;
      border-radius: 0;
      text-align: left;
      color: #fff;
      font-size: 1.01rem;
      letter-spacing: 1px;
    }
    #spinner {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%,-50%);
      display: none;
      z-index: 100;
    }
    .spinner {
      border: 4px solid rgba(255,255,255,0.3);
      border-left-color: #ED2F24;
      border-radius: 50%;
      width: 40px; height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes pop { from { transform: scale(0); } to { transform: scale(1); } }
    .pop-in { animation: pop 0.3s ease-out; }
    .marker-icon {
      width: 40px;
      cursor: pointer;
      filter: drop-shadow(0 2px 8px rgba(0,0,0,0.18));
      transition: filter 0.2s;
    }
    .marker-icon:hover {
      filter: drop-shadow(0 4px 16px #ED2F24);
    }
    .cluster-marker {
      background: linear-gradient(135deg, #ED2F24 70%, #ff5e3a 100%);
      color: #fff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 0 0 2px rgba(255,255,255,0.6), 0 2px 8px 0 rgba(0,0,0,0.18);
      border: 2px solid #fff;
      transition: box-shadow 0.2s;
    }
    .cluster-marker:hover {
      box-shadow: 0 0 0 4px #ED2F24, 0 4px 16px 0 rgba(237,47,36,0.18);
    }
    @media (max-width: 900px) {
      #map {
        right: 0;
      }
      .floating-panel {
        width: 98vw;
        max-width: 98vw;
        left: 1vw;
        right: 1vw;
        border-radius: 18px 18px 0 0;
        top: auto;
        bottom: 0;
        height: 60vh;
        min-height: 320px;
        padding: 18px 8px 12px 8px;
        box-shadow: 0 -4px 32px 0 rgba(0,0,0,0.25);
      }
      #contact-list {
        max-height: 120px;
      }
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="floating-panel">
    <div class="title">Member Directory</div>
    <div class="toolbar">
      <input id="search" type="text" placeholder="Search name, email, phone, address..." aria-label="Search contacts" />
      <button id="show-all" title="Show all members on map">All</button>
      <button id="download" title="Download CSV">CSV</button>
    </div>
    <div id="info-box">
      <div id="basic-info"><em>Loading contacts…</em></div>
      <button id="toggle-details">Details</button>
      <div id="extra-details"></div>
    </div>
    <div id="contact-list-module">
      <div id="sort-container">
        Sort by:
        <select id="sort-select">
          <option value="first">First Name</option>
          <option value="last">Last Name</option>
          <option value="state">State</option>
          <option value="career">Career</option>
        </select>
      </div>
      <ul id="contact-list"></ul>
    </div>
  </div>
  <div id="spinner"><div class="spinner"></div></div>
  <script>
    mapboxgl.accessToken =
      'pk.eyJ1IjoianVzdGluc2luY2xhaXJjcmVhdGl2ZSIsImEiOiJjbTl2dmJ2Z20wb3M4MnFtdzVqZ3l1YTdtIn0.yRr3osd2oFqcKbjg_3O1Hg';
    const sheetId = '1dz75cfpN0r3YDVSjmESMOYgXcQYyRyo10RagGGdI1mw',
          gid     = '577841645';
    const defaultView = { center:[-97.695029, 37.443203], zoom:3.78, pitch:0, bearing:0 };
    const icons = {
      default: 'https://justinjamessinclair.github.io/sonsunitedmapboxassets/SonsUnitedIcon-80px.png',
      hover:   'https://justinjamessinclair.github.io/sonsunitedmapboxassets/SonsUnitedIcon-80px-gs.png',
      click:   'https://justinjamessinclair.github.io/sonsunitedmapboxassets/SonsUnitedIcon-80px-white.png'
    };

    let contacts=[], clusterIndex, markers={}, selectedIdx=null;
    const spinner      = document.getElementById('spinner'),
          basicInfo    = document.getElementById('basic-info'),
          toggleBtn    = document.getElementById('toggle-details'),
          extraDetails = document.getElementById('extra-details'),
          sortSelect   = document.getElementById('sort-select'),
          contactList  = document.getElementById('contact-list');

    const map=new mapboxgl.Map({
      container:'map',
      style:'mapbox://styles/justinsinclaircreative/cma43snlr002t01sih71s9nng',
      ...defaultView
    });

    map.on('load',()=>{
      // Removed GeolocateControl
      map.addControl(new mapboxgl.NavigationControl(),'top-right');
      class Recenter{
        onAdd(m){ this.btn=document.createElement('button');
          this.btn.textContent='⟳'; this.btn.className='mapboxgl-ctrl-recenter';
          this.btn.onclick=()=>m.flyTo({...defaultView,speed:2});
          this.cont=document.createElement('div');
          this.cont.className='mapboxgl-ctrl mapboxgl-ctrl-group';
          this.cont.appendChild(this.btn);
          return this.cont;
        }
        onRemove(){ this.cont.remove(); }
      }
      map.addControl(new Recenter(),'top-right');
      Promise.all([
        new Promise((r,j)=>map.loadImage(icons.default,(e,i)=>e?j(e):r(['default',i]))),
        new Promise((r,j)=>map.loadImage(icons.hover,  (e,i)=>e?j(e):r(['hover',i]))),
        new Promise((r,j)=>map.loadImage(icons.click,  (e,i)=>e?j(e):r(['click',i])))
      ]).then(imgs=>{
        imgs.forEach(([n,i])=>map.addImage(n,i));
        fetchData();
      }).catch(console.error);
    });

    function fetchData(){
      spinner.style.display='block';
      window.google={visualization:{Query:{setResponse:res=>{
        contacts=res.table.rows.map(r=>({
          fullName:r.c[2]?.v, email:r.c[1]?.v, phone:r.c[3]?.v,
          address:r.c[4]?.v, career:r.c[5]?.v,
          strengths:r.c[6]?.v, notes:r.c[7]?.v, coords:null
        }));
        basicInfo.textContent=`${contacts.length} Sons United members:`;
        geocodeAll();
      }}}};
      const s=document.createElement('script');
      s.src=`https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?gid=${gid}&tqx=out:json-in-script`;
      document.head.appendChild(s);
    }

    async function geocodeAll(){
      await Promise.all(contacts.map(async r=>{
        const key=`geo_${r.address}`, st=localStorage.getItem(key);
        if(st) r.coords=JSON.parse(st);
        else {
          try{
            const js=await fetch(
              `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(r.address)}.json?access_token=${mapboxgl.accessToken}`
            ).then(x=>x.json());
            r.coords=js.features[0]?.geometry.coordinates||[0,0];
            localStorage.setItem(key,JSON.stringify(r.coords));
          }catch{r.coords=[0,0];}
        }
      }));
      spinner.style.display='none';
      buildClusterIndex();
      sortSelect.value='first';
      initList();
    }

    function buildClusterIndex(){
      const feats=contacts.map((r,i)=>({
        type:'Feature',id:i,geometry:{type:'Point',coordinates:r.coords},properties:{}
      }));
      clusterIndex=new Supercluster({radius:60,maxZoom:16});
      clusterIndex.load(feats);
      map.on('moveend',updateClusters);
      updateClusters();
    }

    function updateClusters() {
      const bbox = map.getBounds().toArray().flat();
      const z    = Math.floor(map.getZoom());
      const cls  = clusterIndex.getClusters(bbox, z);
      const need = new Set();

      cls.forEach(c => {
        if (c.properties.cluster) need.add(`c_${c.properties.cluster_id}`);
        else                      need.add(`p_${c.id}`);
      });

      for (const k in markers) {
        if (!need.has(k)) {
          markers[k].remove();
          delete markers[k];
        }
      }

      cls.forEach(c => {
        if (c.properties.cluster) {
          const key = `c_${c.properties.cluster_id}`;
          if (markers[key]) return;
          const [lng, lat] = c.geometry.coordinates;
          const cnt        = c.properties.point_count_abbreviated;
          const el         = document.createElement('div');
          el.className     = 'cluster-marker pop-in';
          el.textContent   = cnt;
          const size       = 20 + cnt * 5;
          el.style.width   = `${size}px`;
          el.style.height  = `${size}px`;
          el.onclick       = () => {
            const ez = clusterIndex.getClusterExpansionZoom(c.properties.cluster_id);
            map.easeTo({ center: [lng, lat], zoom: ez, speed: 2 });
          };
          markers[key] = new mapboxgl.Marker(el)
                            .setLngLat([lng, lat])
                            .addTo(map);
        } else {
          const key = `p_${c.id}`;
          if (markers[key]) return;
          const [lng, lat] = c.geometry.coordinates;
          const img        = document.createElement('img');
          img.className    = 'marker-icon pop-in';
          img.src          = c.id===selectedIdx ? icons.click : icons.default;
          img.onmouseenter = () => img.src = c.id===selectedIdx ? icons.click : icons.hover;
          img.onmouseleave = () => img.src = c.id===selectedIdx ? icons.click : icons.default;
          img.onclick      = () => onContactClick(c.id);
          markers[key]     = new mapboxgl.Marker(img)
                                .setLngLat([lng, lat])
                                .addTo(map);
        }
      });
    }

    document.getElementById('show-all').onclick=()=>{
      if(!contacts.length) return;
      const all=contacts.map(r=>r.coords),
            bounds=all.reduce((b,c)=>b.extend(c),new mapboxgl.LngLatBounds(all[0],all[0]));
      map.fitBounds(bounds,{padding:20,speed:2});
    };

    document.getElementById('search').oninput=e=>{
      const q=e.target.value.toLowerCase(),
            f=contacts.filter(r=>[r.fullName,r.email,r.phone,r.address].join(' ').toLowerCase().includes(q)),
            feats=f.map(r=>({type:'Feature',id:contacts.indexOf(r),geometry:{type:'Point',coordinates:r.coords},properties:{}}));
      clusterIndex.load(feats);
      updateClusters();
      reorderList(f);
    };

    document.getElementById('download').onclick=()=>{
      const header=['Full Name','City','State','Zip Code','Email','Phone','Career/Work','Strengths/Interests','Notes'],
            rows=[header,...contacts.map(r=>{
              const p=r.address.split(',').map(s=>s.trim()).filter(Boolean);
              return [r.fullName,p[1]||'',p[2]||'',p[3]||'',r.email,r.phone,r.career,r.strengths,r.notes];
            })],
            csv=rows.map(r=>r.map(c=>`"${c}"`).join(',')).join('\n'),
            b=new Blob([csv],{type:'text/csv'}),u=URL.createObjectURL(b),a=document.createElement('a');
      a.href=u; a.download='contacts.csv'; a.click(); URL.revokeObjectURL(u);
    };

    sortSelect.onchange=()=>reorderList(contacts);

    // Utility: get visible contact indices in map view
    function getContactsInView() {
      if (!contacts.length) return [];
      const bounds = map.getBounds();
      return contacts
        .map((r, i) => ({ r, i }))
        .filter(({ r }) => {
          if (!r.coords) return false;
          const [lng, lat] = r.coords;
          return bounds.contains([lng, lat]);
        })
        .map(({ i }) => i);
    }

    // Modified reorderList to bring in-view contacts to top and highlight them
    function reorderList(list) {
      contactList.innerHTML = '';
      const crit = sortSelect.value;
      const inViewIdxs = new Set(getContactsInView());
      const activeIdx = selectedIdx;

      // Helper to create a contact <li>
      function makeLi(r, idx) {
        const li = document.createElement('li');
        li.textContent = r.fullName;
        li.tabIndex = 0;
        if (idx === activeIdx) li.classList.add('active-contact');
        else if (inViewIdxs.has(idx)) li.classList.add('in-view');
        li.onclick = () => {
          map.flyTo({ center: r.coords, zoom: map.getZoom(), speed: 2 });
          onContactClick(idx);
        };
        return li;
      }

      // If sorting by first name: flat alphabetical, no headers
      if (crit === 'first') {
        // Bring in-view contacts to top
        const withIdx = list.map(r => ({ r, idx: contacts.indexOf(r) }));
        const inView = withIdx.filter(x => inViewIdxs.has(x.idx));
        const notInView = withIdx.filter(x => !inViewIdxs.has(x.idx));
        [...inView, ...notInView]
          .sort((a, b) => a.r.fullName.localeCompare(b.r.fullName))
          .forEach(({ r, idx }) => contactList.appendChild(makeLi(r, idx)));
        return;
      }

      // Otherwise group with headers
      const groups = {};
      list.forEach(r => {
        let key = '';
        if (crit === 'last')   key = r.fullName.split(' ').slice(-1)[0][0].toUpperCase();
        if (crit === 'state')  key = (r.address.split(',').map(s=>s.trim())[2]||'');
        if (crit === 'career') key = r.career||'';
        groups[key] = groups[key] || [];
        groups[key].push(r);
      });
      Object.keys(groups).sort().forEach(hdr => {
        const hli = document.createElement('li');
        hli.textContent = hdr;
        hli.className = 'list-header';
        contactList.appendChild(hli);

        // Bring in-view contacts to top within each group
        const group = groups[hdr].map(r => ({ r, idx: contacts.indexOf(r) }));
        const inView = group.filter(x => inViewIdxs.has(x.idx));
        const notInView = group.filter(x => !inViewIdxs.has(x.idx));
        [...inView, ...notInView]
          .sort((a, b) => {
            if (crit === 'last') {
              const la = a.r.fullName.split(' ').slice(-1)[0],
                    lb = b.r.fullName.split(' ').slice(-1)[0];
              return la.localeCompare(lb);
            }
            return a.r.fullName.localeCompare(b.r.fullName);
          })
          .forEach(({ r, idx }) => contactList.appendChild(makeLi(r, idx)));
      });
    }

    // Listen for map move to update highlights
    map.on('moveend', () => reorderList(contacts));

    // When a contact is selected, expand info box and update list
    function onContactClick(i){
      if(selectedIdx!==null){
        const oldMk=markers[`p_${selectedIdx}`];
        if(oldMk) oldMk.getElement().src=icons.default;
      }
      selectedIdx=i;
      const newMk=markers[`p_${i}`];
      if(newMk) newMk.getElement().src=icons.click;
      showInfo(i);
      toggleBtn.classList.add('visible');
      document.getElementById('info-box').classList.add('expanded');
      reorderList(contacts);
    }

    // When no contact is selected, shrink info box
    function showDefaultInfo() {
      basicInfo.innerHTML = `<em>${contacts.length} Sons United members:</em>`;
      extraDetails.innerHTML = '';
      extraDetails.style.display = 'none';
      toggleBtn.classList.remove('visible');
      document.getElementById('info-box').classList.remove('expanded');
    }
    function showInfo(i){
      const r=contacts[i], p=r.address.split(',').map(s=>s.trim()).filter(Boolean),
            city=p[1]||'', stzp=p[2]?(p[2]+(p[3]?', '+p[3]:'')):'';
      basicInfo.innerHTML=`
        <h3>${r.fullName}</h3>
        <p>${city}${stzp?(', '+stzp):''}</p>
        <p>${r.email}</p><p>${r.phone}</p>`;
      extraDetails.innerHTML=`
        <p><strong>Career/Work:</strong> ${r.career}</p>
        <p><strong>Strengths/Interests:</strong> ${r.strengths}</p>
        <p><strong>Notes:</strong> ${r.notes}</p>`;
      extraDetails.style.display='none';
      toggleBtn.textContent='Details';
      document.getElementById('info-box').classList.add('expanded');
    }

    // On page load, show default info and shrink info box
    if (contacts.length === 0) {
      basicInfo.innerHTML = `<em>Loading contacts…</em>`;
      document.getElementById('info-box').classList.remove('expanded');
    }
    toggleBtn.classList.remove('visible');

    // When clicking outside a contact, reset info box
    document.body.addEventListener('click', function(e) {
      if (
        !e.target.closest('#contact-list') &&
        !e.target.closest('#info-box') &&
        !e.target.closest('.marker-icon')
      ) {
        selectedIdx = null;
        showDefaultInfo();
        reorderList(contacts);
        // Reset marker icons
        Object.keys(markers).forEach(k => {
          if (k.startsWith('p_')) {
            markers[k].getElement().src = icons.default;
          }
        });
      }
    });

    function initList() {
      reorderList(contacts);
      // Ensure the contact list is visible on load (no action needed if always rendered)
      // Optionally, you can scroll to top:
      contactList.scrollTop = 0;
    }

    initList();
  </script>
</body>
</html>
